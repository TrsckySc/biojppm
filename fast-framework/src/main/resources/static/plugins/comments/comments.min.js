/*!
 * 评论回复插件
 * Copyright (c) 2020-Now http://www.j2eefast.com All rights reserved.
 * No deletion without permission
 * @author ZhouHuan
 * @date 2021年02月27日16:43:48
 * @version v1.0
 */
(function(d){var e=function(j){var g=arguments,f=true,h=1;j=j.replace(/%s/g,function(){var i=g[h++];if(typeof i==="undefined"){f=false;return""}return i});return f?j:""};var b=function(g,i,h,f){var j=i;if(typeof i==="string"){var k=i.split(".");if(k.length>1){j=window;d.each(k,function(l,m){j=j[m]})}else{j=window[i]}}if(typeof j==="object"){return j}if(typeof j==="function"){return j.apply(g,h)}if(!j&&typeof i==="string"&&e.apply(this,[i].concat(h))){return e.apply(this,[i].concat(h))}return f};var c=function(g,f){this.options=f;this.$el=d(g);this.$el_=this.$el.clone();this.timeoutId_=0;this.timeoutFooter_=0;this.init()};c.prototype.init=function(){this.initLocale();this.initContainer();this.initFoorter();this.initAvatar();this.initCommentData();this.hideLoading()};c.prototype.initContainer=function(){this.$container=d(['<div class="comment-wrap-box">','<div class="comment-wrap-box__title">','<i class="'+this.options.titleIcon+'"></i>'+d.i18n.text(this.options.title),"</div>",'<div class="comment-wrap-box__inner">','<div class="comment-wrap-box-loading">','<span class="loading-wrap">','<span class="loading-text" style="font-size: 13px;">',this.options.formatLoadingMessage(),"</span>",'<span class="animation-wrap">','<span class="animation-dot"></span>',"</span>","</span>","</div>",'<div class="comments-box">','<div class="comment-form-container">','<div class="comment-avatar-wrap">',"</div>",'<div class="comment-form-wrap">','<form class="comment-form">','<div class="textarea-wrap">',"</div>",'<div class="footer-wrap">',"</div>","</from>","</div>","</div>",'<div class="comments-box__list">',"</div>","</div>","</div>","</div>"].join(""));this.$container.insertAfter(this.$el);this.$comment_wrap_box_loading=this.$container.find(".comment-wrap-box-loading");this.$comments_box=this.$container.find(".comments-box");this.$comment_avatar_wrap=this.$comments_box.find(".comment-avatar-wrap");this.$textarea_wrap=this.$comments_box.find(".textarea-wrap");this.$comments_box__list=this.$comments_box.find(".comments-box__list");this.$footer_wrap=this.$comments_box.find(".footer-wrap");this.$textarea_wrap.append(this.$el);this.$comments_box.css("visibility","hidden")};c.prototype.initAvatar=function(){var h=this,g=[],f=[];d.get(baseURL+"sys/user/getAvatar/"+this.options.userId,function(i){if(i&&i.code==opt.variable.web_status.SUCCESS){f.push('<div title="'+i.name+'" data-user-id="'+h.options.userId+'" class="comment-avatar _35x35">','<img src="'+ctx+i.url+'" alt="'+i.name+'" title="'+i.name+'">',"</div>");h.$comment_avatar_wrap.append(f.join(""))}})};c.prototype.initFoorter=function(){var g=this,f=[];f.push('<div class="toolbar"></div>','<div class="actions">','<div class="osc-button fluid basic btn-action btn-cancel">'+this.options.formatCancel()+"</div>",'<div class="osc-button fluid primary btn-action btn-publish disabled">'+this.options.formatRelease()+"</div>","</div>");this.$toolbar=d(f.join(""));this.$footer_wrap.append(this.$toolbar);this.$actions=this.$footer_wrap.find("div.actions");this.$textarea_wrap.find("textarea").off("focus").on("focus",function(){if(!g.$footer_wrap.hasClass("active")){g.$footer_wrap.addClass("active")}});this.$actions.find(".btn-cancel").off("click").on("click",d.proxy(this.onCancel,this));this.$actions.find(".btn-publish").off("click").on("click",d.proxy(this.onPublish,this));this.$textarea_wrap.find("textarea").bind("input propertychange",function(){var h=d(this).val();if(h&&h.length>0){if(g.$actions.find("div.btn-publish").hasClass("disabled")){g.$actions.find("div.btn-publish").removeClass("disabled")}}else{if(!g.$actions.find("div.btn-publish").hasClass("disabled")){g.$actions.find("div.btn-publish").addClass(("disabled"))}}})};c.prototype.initCommentData=function(){var h=this,g={},j={};if(this.options.sortName!==""){g={__sidx:this.options.sortName,__order:this.options.sortOrder}}j.offset=this.options.pageSize*(this.options.pageNumber-1);j.limit=this.options.pageSize;var i={__limit:j.limit,__page:j.offset/j.limit+1,};g["msgId"]=this.options.msgId;g=d.extend(i,g);var f={type:"POST",url:baseURL+this.options.listURL,data:g,dataType:"JSON",success:function(k,m,l){k=b(h.options,h.options.responseHandler,[k],k);h.load(k)},error:function(k,l){},};if(opt.common.isNotEmpty(d('meta[name="csrf-token"]').attr("content"))){f=d.extend(f,{headers:{"X-CSRF-Token":d('meta[name="csrf-token"]').attr("content")||""}})}d.ajax(f)};c.prototype.load=function(g){var i=[],h=this,j={},f="";if(g&&g.code=="00000"&&g.msg=="SUCCESS"&&g.data.totalCount>0){h.options.totalRows=g.data.totalCount;i.push('<div class="comment-title">');i.push(this.options.formatCommentTitle(h.options.totalRows));i.push("</div>");i.push('<div class="comment-list">');i.push("</div>");this.$comments_box__list.empty().append(i.join(""));this.$comment_list=this.$comments_box__list.find("div.comment-list");
    this.options.data=g.data.list;this.dataAnalyze(this.options.data,j);this.commentList(this.options.data,false,j);if(this.options.isMore&&this.options.data.length>2){f=['<div class="collapse-bar">','<span class="collapse-btn">'+this.options.formatCommentMore()+' <i class="fa fa-angle-down"></i></span>',"</div>"].join("");this.$comments_box__list.after(f);this.options.isMore=false;this.$comments_box.find(".collapse-bar").off("click").on("click",function(){h.localLoad();h.$comments_box.find(".collapse-bar").remove()})}else{this.options.isMore=false;this.initPagination()}}else{this.$comments_box__list.empty()}};c.prototype.localLoad=function(){var g=[],f=this,h={};g.push('<div class="comment-title">');g.push(this.options.formatCommentTitle(f.options.totalRows));g.push("</div>");g.push('<div class="comment-list">');g.push("</div>");this.$comments_box__list.empty().append(g.join(""));this.$comment_list=this.$comments_box__list.find("div.comment-list");this.dataAnalyze(this.options.data,h);this.commentList(this.options.data,false,h);this.initPagination()};c.prototype.initPagination=function(){var h=this.options.data,k=[],l=this,o,p;this.totalPages=0;if(this.options.totalRows){this.totalPages=~~((this.options.totalRows-1)/this.options.pageSize)+1;this.options.totalPages=this.totalPages}this.pageFrom=(this.options.pageNumber-1)*this.options.pageSize+1;this.pageTo=this.options.pageNumber*this.options.pageSize;if(this.pageTo>this.options.totalRows){this.pageTo=this.options.totalRows}d.each(this.options.pageList,function(s,t){if(l.options.totalRows>t){l.options.onlyInfoPagination=true}});this.$comments_box__list.find("div.comment-pagination").remove();if(this.options.onlyInfoPagination&&this.totalPages>1){k.push('<div class="comment-pagination" data-page="'+this.options.pageNumber+'">');k.push('<ul class="pagination pagination-outline">');k.push('<li class="page-pre"><a href="javascript:void(0)">'+this.options.paginationPreText+"</a></li>");if(this.totalPages<5){o=1;p=this.totalPages}else{o=this.totalPages-2;p=o+4;if(o<1){o=1;p=5}if(p>this.totalPages){p=this.totalPages;o=p-4}}if(this.totalPages>=6){if(this.options.pageNumber>=3){k.push('<li class="page-first'+(1==this.options.pageNumber?" active":"")+'">','<a href="javascript:void(0)">',1,"</a>","</li>");o++}if(this.options.pageNumber>=4){if(this.options.pageNumber==4||this.totalPages==6||this.totalPages==7){o--}else{k.push('<li class="page-first-separator disabled">','<a href="javascript:void(0)">...</a>',"</li>")}p--}}if(this.totalPages>=7){if(this.options.pageNumber>=(this.totalPages-2)){o--}}if(this.totalPages==6){if(this.options.pageNumber>=(this.totalPages-2)){p++}}else{if(this.totalPages>=7){if(this.totalPages==7||this.options.pageNumber>=(this.totalPages-3)){p++}}}for(var j=o;j<=p;j++){k.push('<li class="page-number'+(j==this.options.pageNumber?" active":"")+'">','<a href="javascript:void(0)">',j,"</a>","</li>")}if(this.totalPages>=8){if(this.options.pageNumber<=(this.totalPages-4)){k.push('<li class="page-last-separator disabled">','<a href="javascript:void(0)">...</a>',"</li>")}}if(this.totalPages>=6){if(this.options.pageNumber<=(this.totalPages-3)){k.push('<li class="page-last'+(this.totalPages===this.options.pageNumber?" active":"")+'">','<a href="javascript:void(0)">',this.totalPages,"</a>","</li>")}}k.push('<li class="page-next"><a href="javascript:void(0)">'+this.options.paginationNextText+"</a></li>");k.push("</ul></div>");this.$comment_list.after(k.join(""));var m=this.$comments_box__list.find("div.comment-pagination");var r=m.find(".page-pre");var f=m.find(".page-next");var q=m.find(".page-number");var g=m.find(".page-first");var n=m.find(".page-last");g.off("click").on("click",d.proxy(this.onPageFirst,this));r.off("click").on("click",d.proxy(this.onPagePre,this));q.off("click").on("click",d.proxy(this.onPageNumber,this));n.off("click").on("click",d.proxy(this.onPageLast,this));f.off("click").on("click",d.proxy(this.onPageNext,l))}};c.prototype.onPagePre=function(f){if((this.options.pageNumber-1)===0){this.options.pageNumber=this.options.totalPages}else{this.options.pageNumber--}this.initCommentData()};c.prototype.onPageNext=function(f){if((this.options.pageNumber+1)>this.options.totalPages){this.options.pageNumber=1}else{this.options.pageNumber++}this.initCommentData()};c.prototype.onPageFirst=function(f){this.options.pageNumber=1;this.initCommentData()};c.prototype.onPageLast=function(f){this.options.pageNumber=this.options.totalPages;this.initCommentData()};c.prototype.onPageNumber=function(f){if(this.options.pageNumber==d(f.currentTarget).text()){return}this.options.pageNumber=d(f.currentTarget).text();this.initCommentData()};c.prototype.dataAnalyze=function(h,j){for(var g=0;g<h.length;g++){if(h[g].reply){if(h[g].replyId=="0"){j[h[g].id]={level:0,name:h[g].userName}}else{var f=j[h[g].replyId].level+1;j[h[g].id]={level:f,name:h[g].userName};if(f==5){j[h[g].id+"_f"]=h[g].replyId}if(f>5){j[h[g].id+"_f"]=j[h[g].replyId+"_f"]}}this.dataAnalyze(h[g].children,j)
}else{if(h[g].replyId=="0"){j[h[g].id]={level:0,name:h[g].userName}}else{var f=j[h[g].replyId].level+1;j[h[g].id]={level:f,name:h[g].userName};if(f==5){j[h[g].id+"_f"]=h[g].replyId}if(f>5){j[h[g].id+"_f"]=j[h[g].replyId+"_f"]}}}}};c.prototype.recursive=function(h,j){for(var g=0;g<h.length;g++){if(h[g].id==j){return h[g]}if(h[g].reply){var f=this.recursive(h[g].children,j);if(f){return f}}}};c.prototype.commentList=function(j,g,k){var f=[],i=false,h=this;d.each(j,function(m,n){if(h.options.isMore){if(m>2&&n.replyId=="0"){return}}f=[],i=n.userId==h.options.userId;var o=g?'<div class="comment-item__children">':"",l="";o=o+['<div class="comment-item"'+(g?" comment-item--child":""),e(' id="%s"',n.id),e(' name="c_%s"',n.id),e(' data-comment-id="%s"',n.id),e(' data-comment-parent-id="%s"',n.replyId),e(' data-comment-is-last-level="%s"',n.reply),e(' data-comment-user-id="%s"',n.userId),e(' data-comment-user-id="%s"',n.userId),e(' data-comment-user-name="%s"',n.userName),(k[n.id].level>5)?e(' data-comment-at="%s"',true):e(' data-comment-at="%s"',false),">"].join("");f.push(o+'<div class="comment-item__inner" data-id="_inner_'+n.id+'">');l=['<div class="comment-item__avatar">','<a href="#">','<div class="comment-avatar _35x35" title="'+n.userName+'" data-user-id="'+n.userId+'">','<img src="'+ctx+n.avatar+'" alt="'+n.userName+'" title="'+n.userName+'">',"</div></a></div>"].join("");f.push(l);f.push('<div class="comment-item__main">'+'<div class="comment-item__header">'+'<div class="comment-item__author">'+'<span class="author">'+n.userName+"</span>"+"</div>"+"</div>"+'<div class="comment-item__content" data-emoji-render="">'+((k[n.id].level>5)?('回复 <span style="color: #00a0e9; font-weight: bold"> @'+k[n.replyId].name+"</span> : "+n.content):n.content)+"</div>");f.push('<div class="comment-item__actions" data-id="_actions_'+n.id+'">'+'<div class="item-list">'+'<div class="item">'+n.commentsDate+"</div>"+"</div>");f.push('<div class="item-list">'+'<div class="item">'+'<span class="clickable" data-id="'+n.id+'"><i class="fa fa-comment"></i> '+h.options.formatCommentReply()+"</span>"+"</div>");if(i){f.push('<div class="item">'+'<span class="clickable" data-toggle-remove="'+n.id+'"><i class="fa fa-trash"></i> '+h.options.formatDelCommentReply()+"</span>"+"</div>")}f.push("</div></div>");if(!g){f.push("</div></div>");h.$comment_list.append(f.join(""))}else{f.push("</div></div></div>");if(k[n.id].level>5){d("#"+k[n.id+"_f"]).find('.comment-item__inner[data-id="_inner_'+k[n.id+"_f"]+'"]').after(f.join(""))}else{d("#"+n.replyId).find('.comment-item__inner[data-id="_inner_'+n.replyId+'"]').after(f.join(""))}}d("#"+n.id).find('span[data-id="'+n.id+'"]').off("click").on("click",function(){var s=d(this),q=(k[n.id].level>=5)?(" 回复 @ "+k[n.id].name):"",p=h.initReply(s.data("id"),q);d("#"+s.data("id")).find('.comment-item__actions[data-id="_actions_'+s.data("id")+'"]').after(p);var r=d("#"+s.data("id")).find('div[data-comment-id="reply_'+s.data("id")+'"]');r.find(".btn-close").off("click").on("click",function(){d("#__replyCommentForm").remove()});r.find(".field >textarea ").bind("input propertychange",function(){var t=d(this).val();if(t&&t.length>0){if(r.find(".field > .btn-submit ").hasClass("disabled")){r.find(".field > .btn-submit ").removeClass("disabled")}}else{if(!r.find(".field > .btn-submit ").hasClass("disabled")){r.find(".field > .btn-submit ").addClass("disabled")}}});r.find(".field > .btn-submit ").off("click").on("click",d.proxy(h.onReplyPublish,h))});if(i){d("#"+n.id).find('span[data-toggle-remove="'+n.id+'"]').off("click").on("click",function(){opt.modal.confirm("请确认是否删除评论,数据将无法恢复!",function(){h.showLoading();var p={type:"POST",url:baseURL+h.options.delUrl,data:{"id":n.id},success:function(q){if(q.code=="00000"){h.hideLoading();h.initCommentData()}else{if(q.code=="50001"){h.hideLoading();opt.modal.alertWarning(q.msg)}else{h.hideLoading();opt.modal.alertError(q.msg)}}}};if(opt.common.isNotEmpty(d('meta[name="csrf-token"]').attr("content"))){p=opt.common.extend(p,{headers:{"X-CSRF-Token":d('meta[name="csrf-token"]').attr("content")}})}d.ajax(p)})})}if(n.reply){h.commentList(n.children,true,k)}})};c.prototype.showLoading=function(){this.$comment_wrap_box_loading.show();this.$comments_box.css("visibility","hidden")};c.prototype.hideLoading=function(){this.$comment_wrap_box_loading.hide();this.$comments_box.css("visibility","visible")};c.prototype.onCancel=function(f){if(this.$footer_wrap.hasClass("active")){this.$footer_wrap.removeClass("active")}};c.prototype.onPublish=function(i){var h=this;this.showLoading();var g=this.$textarea_wrap.find("textarea").val();var f={type:"POST",url:baseURL+this.options.pushURL,data:{"userId":this.options.userId,"content":g,"msgId":this.options.msgId,"replyId":0},success:function(j){if(j.code=="00000"){h.$textarea_wrap.find("textarea").val("");if(!h.$actions.find("div.btn-publish").hasClass("disabled")){h.$actions.find("div.btn-publish").addClass(("disabled"))}h.hideLoading();h.initCommentData()
    }else{if(j.code=="50001"){h.hideLoading();opt.modal.alertWarning(j.msg)}else{h.hideLoading();opt.modal.alertError(j.msg)}}}};if(opt.common.isNotEmpty(d('meta[name="csrf-token"]').attr("content"))){f=opt.common.extend(f,{headers:{"X-CSRF-Token":d('meta[name="csrf-token"]').attr("content")}})}d.ajax(f)};c.prototype.onReplyPublish=function(i){var h=this,j=d(i.currentTarget).data("id");var g=d("#"+j).find('div[data-comment-id="reply_'+j+'"]').find(".field >textarea ").val();var f={type:"POST",url:baseURL+h.options.pushURL,data:{"userId":h.options.userId,"content":g,"msgId":this.options.msgId,"replyId":j},success:function(k){if(k.code=="00000"){d("#__replyCommentForm").remove();h.hideLoading();h.initCommentData()}else{if(k.code=="50001"){h.hideLoading();opt.modal.alertWarning(k.msg)}else{h.hideLoading();opt.modal.alertError(k.msg)}}}};if(opt.common.isNotEmpty(d('meta[name="csrf-token"]').attr("content"))){f=opt.common.extend(f,{headers:{"X-CSRF-Token":d('meta[name="csrf-token"]').attr("content")}})}d.ajax(f)};c.prototype.initReply=function(h,f){d("#__replyCommentForm").remove();var g=['<div class="comment-item__reply-form" id="__replyCommentForm">','<div  data-reply-comment-form="" data-comment-id="reply_'+h+'">','<form class="ui reply form comment-form">','<div class="field">','<textarea rows="4" placeholder="'+f+'" maxlength="1000" class="disabled-resize"></textarea>',"</div>",'<div class="field foot-bar">','<div class="btn-close">'+this.options.formatCancel()+"</div>",'<div class="btn-submit ui primary button right floated disabled" data-id="'+h+'">'+this.options.formatCommentReply()+"</div>","</div>","</form>","</div>","</div>"].join("");return g};c.prototype.onReply=function(f){console.log(this);var g=d(f.currentTarget).data("id");this.initReply(g)};c.prototype.initLocale=function(){if(this.options.locale){var f=this.options.locale.split(/-|_/);f[0].toLowerCase();if(f[1]){f[1].toUpperCase()}if(d.fn.comments.locales[this.options.locale]){d.extend(this.options,d.fn.comments.locales[this.options.locale])}else{if(d.fn.comments.locales[f.join("-")]){d.extend(this.options,d.fn.comments.locales[f.join("-")])}else{if(d.fn.comments.locales[f[0]]){d.extend(this.options,d.fn.comments.locales[f[0]])}}}}};c.LOCALES={};c.LOCALES["zh-CN"]=c.LOCALES.zh={formatLoadingMessage:function(){return d.i18n.text("努力加载中,请稍后")},formatCancel:function(){return d.i18n.text("取消")},formatRelease:function(){return d.i18n.text("发布")},formatCommentTitle:function(f){return d.i18n.text("最新评论{0}","("+f+")")},formatCommentReply:function(){return d.i18n.text("回复")},formatDelCommentReply:function(){return d.i18n.text("删除")},formatCommentMore:function(){return d.i18n.text("更多评论")}};d.extend(c.DEFAULTS,c.LOCALES["zh-CN"]);c.DEFAULTS={id:"",userId:__USERID__,msgId:"",locale:"zh-CN",sortName:"createTime",sortOrder:"desc",totalRows:0,pageNumber:1,pageSize:6,onlyInfoPagination:false,pageList:[6,12,18],code:"code",isMore:true,rootIdValue:"0",data:[],type:"POST",pushURL:"sys/msg/addCommets",listURL:"sys/msg/commets/list",delUrl:"sys/msg/commets/del",title:"评论留言",titleIcon:"fa fa-fw fa-comments-o",paginationPreText:"&lsaquo;",paginationNextText:"&rsaquo;",responseHandler:function(f){return f}};var a=["onPublish"];d.fn.comments=function(g){var h,f=Array.prototype.slice.call(arguments,1);this.each(function(){var k=d(this),j=k.data("comments.data"),i=d.extend({},c.DEFAULTS,k.data(),typeof g==="object"&&g);if(typeof g==="string"){if(d.inArray(g,a)<0){throw new Error("Unknown method: "+g)}if(!j){return}h=j[g].apply(j,f);if(g==="destroy"){k.removeData("comments.data")}}if(!j){k.data("comments.data",(j=new c(this,i)))}});return typeof h==="undefined"?this:h};d.fn.comments.Constructor=c;d.fn.comments.defaults=c.DEFAULTS;d.fn.comments.locales=c.LOCALES;d.fn.comments.utils={sprintf:e};d(function(){d('[data-toggle="comment"]').comments()})})(jQuery);