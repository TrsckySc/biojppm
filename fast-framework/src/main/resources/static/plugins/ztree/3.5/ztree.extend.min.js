/*!
 * 树封装
 * Copyright (c) 2020-Now http://www.j2eefast.com All rights reserved.
 * No deletion without permission
 * @author ZhouZhou
 */
(function(a){a.extend({_tree:{},tree:{_option:{},_lastValue:{},init:function(c){var e={ajxType:"GET",ajaxParams:{},id:"tree",expandLevel:0,view:{selectedMulti:false,nameIsHTML:true},check:{enable:true,radioType:"level",chkStyle:"radio",nocheckInherit:true},data:{key:{title:"name",name:"title"},simpleData:{enable:true}},displayLen:0};var c=a.extend(e,c);a.tree._option=c;var d={callback:{onClick:c.onClick,onCheck:c.onCheck,onDblClick:c.onDblClick,onCollapse:c.OnCollapse,onExpand:c.OnExpand,beforeClick:c.beforeClick},check:c.check,view:c.view,data:c.data,};var b={url:c.url,type:c.ajxType,dataType:"JSON",data:c.ajaxParams,success:function(m){var l;if(opt.common.isArray(m)){l=m}else{if(m.code==opt.variable.web_status.SUCCESS){for(var h in m){if(opt.common.isArray(m[h])){l=m[h]}}for(var g=0;g<l.length;g++){for(var h in l[g]){if(h=="url"){delete l[g][h]}}}}else{opt.modal.error(m.msg);return}}if(c.displayLen!=0){for(var g=0;g<l.length;g++){for(var h in l[g]){if(h=="title"){l[g][h]=opt.common.subString(l[g][h],c.displayLen,true)}}}}var k=a("#treeId").val();tree=a.fn.zTree.init(a("#"+c.id),d,l);a._tree=tree;if(c.expandLevel==1){var j=tree.getNodesByFilter(function(i){return i.level==0},true);tree.expandNode(j,true,null,null)}if(c.expandLevel==2){tree.expandAll(true)}if(!opt.common.isEmpty(c._list)){var f=c._list.split(",");for(var g=0;g<f.length;g++){var j=tree.getNodeByParam(opt.common.isEmpty(c.data.simpleData.idKey)?"id":c.data.simpleData.idKey,f[g]);if(j!=null){tree.checkNode(j,true);tree.selectNode(j)}}}if(!opt.common.isEmpty(k)){var f=k.split(",");for(var g=0;g<f.length;g++){var j=tree.getNodeByParam(opt.common.isEmpty(c.data.simpleData.idKey)?"id":c.data.simpleData.idKey,f[g]);if(j!=null){tree.checkNode(j,true);tree.selectNode(j)}}}if(typeof(c.callBack)==="function"){c.callBack(a._tree)}}};opt.common.sendAjax(b)},expandAll:function(){a._tree.expandAll(true)},searchNode:function(){var c=opt.common.trim(a("#keyword").val());if(a.tree._lastValue==c){return}a.tree._lastValue=c;var b=a._tree.getNodes();if(c==""){a.tree.showAllNode(b);return}a.tree.hideAllNode(b);a.tree.updateNodes(a._tree.getNodesByParamFuzzy("name",c))},selectByIdName:function(c,b){if(opt.common.isNotEmpty(c)&&c==opt.common.getJsonValue(b,a.tree._option.data.simpleData.idKey)){a._tree.selectNode(b,true)}},showAllNode:function(b){b=a._tree.transformToArray(b);for(var c=b.length-1;c>=0;c--){if(b[c].getParentNode()!=null){a._tree.expandNode(b[c],true,false,false,false)}else{a._tree.expandNode(b[c],true,true,false,false)}a._tree.showNode(b[c]);a.tree.showAllNode(b[c].children)}},hideAllNode:function(c){var b=a.fn.zTree.getZTreeObj("tree");var c=a._tree.transformToArray(c);for(var d=c.length-1;d>=0;d--){a._tree.hideNode(c[d])}},showParent:function(c){var b;while((b=c.getParentNode())!=null){a._tree.showNode(b);a._tree.expandNode(b,true,false,false);c=b}},getParentIds:function(d){if(opt.common.isEmpty(d)){return""}var b=d.id;var c=d.getParentNode();if(c!=null){b=b+","+a.tree.getParentIds(c)}return b},showChildren:function(d){if(d.isParent){for(var b in d.children){var c=d.children[b];a._tree.showNode(c);a.tree.showChildren(c)}}},updateNodes:function(c){a._tree.showNodes(c);for(var d=0,b=c.length;d<b;d++){var e=c[d];a.tree.showChildren(e);a.tree.showParent(e)}},refreshNode:function(){a._tree.reAsyncChildNodes(null,"refresh")},getCheckedNodes:function(c){var e=opt.common.isEmpty(c)?(opt.common.isEmpty(a.tree._option.data.simpleData.idKey)?"id":a.tree._option.data.simpleData.idKey):c;var b=a._tree.getCheckedNodes(true);var d=a.map(b,function(f){return f[e]}).join();return d.split(",")},notAllowParents:function(b){return true},notAllowLastLevel:function(d){var b=d.getSelectedNodes();for(var c=0;c<b.length;c++){if(!b[c].isParent){a.modal.msgError("不能选择最后层级节点（"+b[c].name+"）");return false}}return true},toggleSearch:function(){a("#search").slideToggle(200);a("#btnShow").toggle();a("#btnHide").toggle();a("#keyword").focus()},checkAllNodes:function(b){a._tree.checkAllNodes(b)},collapse:function(){a._tree.expandAll(false)},expand:function(){a._tree.expandAll(true)},callBackTree:function(b,e){var k=b.find("iframe")[0].contentWindow.$._tree;if(a.tree.notAllowParents(k)){var g=layer.getChildFrame("body",e);var f=g.find("#treeId").val();var h=g.find("#treeName").val();var j=g.find("#parentIds").val();var d=g.find("#treeTitle").val();var i=g.find("#type").val();var c='{"id":"'+f+'","name":"'+h+'","title":"'+d+'","parentIds":"'+j+'","type":"'+i+'"}';return a.parseJSON(c)}else{return false}}}})})(jQuery);