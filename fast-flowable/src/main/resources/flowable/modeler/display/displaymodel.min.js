var NORMAL_STROKE=2;var SEQUENCEFLOW_STROKE=1.5;var ASSOCIATION_STROKE=2;var TASK_STROKE=1;var TASK_HIGHLIGHT_STROKE=2;var CALL_ACTIVITY_STROKE=2;var ENDEVENT_STROKE=3;var COMPLETED_COLOR="#017501";var TEXT_COLOR="#373e48";var CURRENT_COLOR="#FF0000";var HOVER_COLOR="#1890ff";var ACTIVITY_STROKE_COLOR="#bbbbbb";var ACTIVITY_FILL_COLOR="#f9f9f9";var MAIN_STROKE_COLOR="#444";var TEXT_PADDING=3;var ARROW_WIDTH=4;var MARKER_WIDTH=12;var TASK_FONT={font:"11px Arial",opacity:1,fill:Raphael.rgb(0,0,0)};var ICON_SIZE=16;var ICON_PADDING=4;var INITIAL_CANVAS_WIDTH;var INITIAL_CANVAS_HEIGHT;var paper;var viewBox;var viewBoxWidth;var viewBoxHeight;var canvasWidth;var canvasHeight;var modelDiv=jQuery("#bpmnModel");var modelId=modelDiv.attr("data-model-id");var historyModelId=modelDiv.attr("data-history-id");var processDefinitionId=modelDiv.attr("data-process-definition-id");var modelType=modelDiv.attr("data-model-type");var isDebuggerEnabled=modelDiv.attr("data-debugger-enabled")=="true";var isSelectEnabled=modelDiv.attr("data-select-enabled")=="true";var customActivityColors=modelDiv.attr("data-activity-color-mapping");if(customActivityColors!==null&&customActivityColors!==undefined&&customActivityColors.length>0){customActivityColors=JSON.parse(customActivityColors)}var customActivityToolTips=modelDiv.attr("data-activity-tooltips");if(customActivityToolTips!==null&&customActivityToolTips!==undefined&&customActivityToolTips.length>0){customActivityToolTips=JSON.parse(customActivityToolTips)}var customActivityBackgroundOpacity=modelDiv.attr("data-activity-opacity");var elementsAdded=new Array();var elementsRemoved=new Array();function _showTip(l,e){var h=undefined;if(customActivityToolTips){if(customActivityToolTips[e.name]){h=customActivityToolTips[e.name]}else{if(customActivityToolTips[e.id]){h=customActivityToolTips[e.id]}else{h=""}}}if(h===undefined){var h="";if(e.name&&e.name.length>0){h+="<b>名称</b>: <i>"+e.name+"</i><br/><br/>"}if(modelType=="runtime"){if(window.modelData){if(e.type=="UserTask"&&(e.completed||e.current)){var b=e.id;var d=window.modelData;var k=false;for(var f=0;f<d.length;f++){if(d[f].actId==b){if(d[f].userId){h+="<b>"+d[f].typeName+"人</b>: <i>"+d[f].userName+"</i><br/><br/><b>"+d[f].typeName+"时间</b>: "+d[f].endTime+"<br/><br/>";k=true;break}}}if(!k){h+="<b><span style='color: red; font-weight: bold'>无人处理</span><br/>"}}}}else{if(e.properties){for(var f=0;f<e.properties.length;f++){var g=e.properties[f].name;var a=e.properties[f].value;if(g=="Assignee"){g="处理人:";continue}if(e.properties[f].type&&e.properties[f].type==="list"){h+="<b>"+g+"</b>:<br/>";for(var c=0;c<e.properties[f].value.length;c++){h+="<i>"+e.properties[f].value[c]+"</i><br/>"}}else{h+="<b>"+g+"</b>: <i>"+e.properties[f].value+"</i><br/>"}}}}}var m="";if(e.name&&e.name.length>0){m+=e.id}else{return}l.qtip({content:{text:h,title:{text:m}},position:{my:"top left",at:"bottom center",viewport:jQuery("#bpmnModel")},hide:{fixed:true,delay:500,event:"click mouseleave"},style:{classes:"ui-tooltip-kisbpm-bpmn"}})}function _addHoverLogic(d,f,b){var i=_bpmnGetColor(d,b);var c=null;if(f==="rect"){c=paper.rect(d.x,d.y,d.width,d.height)}else{if(f==="circle"){var h=d.x+(d.width/2);var g=d.y+(d.height/2);c=paper.circle(h,g,15)}else{if(f==="rhombus"){c=paper.path("M"+d.x+" "+(d.y+(d.height/2))+"L"+(d.x+(d.width/2))+" "+(d.y+d.height)+"L"+(d.x+d.width)+" "+(d.y+(d.height/2))+"L"+(d.x+(d.width/2))+" "+d.y+"z")}}}var e=0;var a="#ffffff";if(jQuery.inArray(d.id,elementsAdded)>=0){e=0.2;a="green"}if(jQuery.inArray(d.id,elementsRemoved)>=0){e=0.2;a="red"}c.attr({opacity:e,stroke:"none",fill:a});if(!isSelectEnabled){_showTip(jQuery(c.node),d)}c.mouseover(function(){paper.getById(d.id).attr({stroke:HOVER_COLOR})});c.mouseout(function(){paper.getById(d.id).attr({stroke:i})})}function _zoom(c){var b,a;if(c){b=canvasWidth*(1/0.9);a=canvasHeight*(1/0.9)}else{b=canvasWidth*(1/1.1);a=canvasHeight*(1/1.1)}if(b!=canvasWidth||a!=canvasHeight){canvasWidth=b;canvasHeight=a;paper.setSize(canvasWidth,canvasHeight)}}var modelUrl;if(modelType=="runtime"){if(historyModelId&&historyModelId!=""){modelUrl=baseURL+"rest/process-instances/history/"+historyModelId+"/model-json"}else{if(modelId&&modelId!=""){if(isDebuggerEnabled){modelUrl=baseURL+"rest/process-instances/debugger/"+modelId+"/model-json"}else{modelUrl=baseURL+"rest/process-instances/"+modelId+"/model-json"}}else{if(processDefinitionId&&processDefinitionId!=""){modelUrl=baseURL+"rest/process-definitions/"+processDefinitionId+"/model-json"}}}}else{if(modelType=="design"){if(historyModelId){modelUrl=FLOWABLE.APP_URL.getModelHistoryModelJsonUrl(modelId,historyModelId)}else{modelUrl=FLOWABLE.APP_URL.getModelModelJsonUrl(modelId)}}else{if(modelType=="process-definition"){modelUrl=FLOWABLE.APP_URL.getProcessDefinitionModelJsonUrl(processDefinitionId)}}}function _showProcessDiagram(){if(modelUrl==undefined){return}jQuery.ajax({type:"GET",url:modelUrl+"?nocaching="+new Date().getTime(),success:function(data){if((!data.elements||data.elements.length==0)&&(!data.pools||data.pools.length==0)){return}INITIAL_CANVAS_WIDTH=data.diagramWidth;if(modelType=="design"){INITIAL_CANVAS_WIDTH+=20}else{INITIAL_CANVAS_WIDTH+=30}INITIAL_CANVAS_HEIGHT=data.diagramHeight+50;canvasWidth=INITIAL_CANVAS_WIDTH;canvasHeight=INITIAL_CANVAS_HEIGHT;viewBoxWidth=INITIAL_CANVAS_WIDTH;viewBoxHeight=INITIAL_CANVAS_HEIGHT;if(modelType=="design"){var headerBarHeight=170;var offsetY=0;if(jQuery(window).height()>(canvasHeight+headerBarHeight)){offsetY=(jQuery(window).height()-headerBarHeight-canvasHeight)/2}if(offsetY>50){offsetY=50}jQuery("#bpmnModel").css("marginTop",offsetY)}paper=Raphael(document.getElementById("bpmnModel"),canvasWidth,canvasHeight);paper.setViewBox(0,0,viewBoxWidth,viewBoxHeight,false);paper.renderfix();if(data.pools){for(var i=0;i<data.pools.length;i++){var pool=data.pools[i];_drawPool(pool)}}var modelElements=data.elements;for(var i=0;i<modelElements.length;i++){var element=modelElements[i];try{console.log("--->>>_draw"+element.type);var drawFunction=eval("_draw"+element.type);drawFunction(element)}catch(err){console.log(err)}}if(data.flows){for(var i=0;i<data.flows.length;i++){var flow=data.flows[i];if(flow.type==="sequenceFlow"){_drawFlow(flow)}else{if(flow.type==="association"){_drawAssociation(flow)}}}}},error:function(e){console.log(e.status);console.log(e.responseText);opt.error("获取流程图信息错误!")}})}_showProcessDiagram();